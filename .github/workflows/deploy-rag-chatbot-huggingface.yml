name: Deploy RAG Chatbot to Hugging Face Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'Backend/RAG_CHATBOT/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install huggingface_hub
        run: pip install huggingface_hub

      - name: Create Hugging Face Space if not exists
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYTHON_SCRIPT'
          import os
          from huggingface_hub import HfApi, create_repo
          from huggingface_hub.utils import RepositoryNotFoundError
          
          api = HfApi(token=os.environ["HF_TOKEN"])
          repo_id = "Imkkrish/tax-assistance-rag-chatbot"
          
          try:
              api.repo_info(repo_id=repo_id, repo_type="space")
              print(f"âœ… Space {repo_id} already exists")
          except RepositoryNotFoundError:
              print(f"Creating new space: {repo_id}")
              create_repo(
                  repo_id=repo_id,
                  repo_type="space",
                  space_sdk="gradio",
                  token=os.environ["HF_TOKEN"],
                  private=False
              )
              print(f"âœ… Space {repo_id} created successfully")
          PYTHON_SCRIPT

      - name: Push RAG_CHATBOT to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          # Install git-lfs
          git lfs install
          
          # Configure git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Clone or create the Hugging Face Space
          SPACE_NAME="tax-assistance-rag-chatbot"
          SPACE_URL="https://huggingface.co/spaces/Imkkrish/${SPACE_NAME}"
          
          # Create a temporary directory for the HF repo
          mkdir -p /tmp/hf-space
          cd /tmp/hf-space
          
          # Clone the space
          git clone "https://Imkkrish:${HF_TOKEN}@huggingface.co/spaces/Imkkrish/${SPACE_NAME}" .
          
          # Verify we are in the correct directory before cleanup
          if [ -d ".git" ] && [ "$(pwd)" = "/tmp/hf-space" ]; then
            # Remove existing files (except .git)
            find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          else
            echo "âŒ Safety check failed: not in expected directory or .git missing"
            exit 1
          fi
          
          # Copy all files from RAG_CHATBOT (including hidden files)
          cp -r $GITHUB_WORKSPACE/Backend/RAG_CHATBOT/. .
          
          # Create app.py for Hugging Face Spaces (Gradio interface)
          cat > app.py << 'EOF'
          """
          Gradio interface for the Tax Assistance RAG Chatbot
          Deployed on Hugging Face Spaces
          """
          import gradio as gr
          import os
          import logging

          # Configure logging
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger(__name__)

          # Try to import the chatbot
          try:
              from rag_chatbot import AdvancedRAGChatbot
              chatbot = AdvancedRAGChatbot("ITA_primary")
              logger.info("âœ… RAG Chatbot initialized successfully")
              CHATBOT_AVAILABLE = True
          except Exception as e:
              logger.error(f"âŒ Error initializing chatbot: {e}")
              chatbot = None
              CHATBOT_AVAILABLE = False

          def respond(message, history):
              """Handle chat messages"""
              if not CHATBOT_AVAILABLE or chatbot is None:
                  return "âš ï¸ Chatbot is not available. Please check the server logs."
              
              try:
                  response = chatbot.ask(message)
                  return response
              except Exception as e:
                  logger.error(f"Error processing query: {e}")
                  return f"âŒ Error: {str(e)}"

          # Create Gradio interface
          demo = gr.ChatInterface(
              respond,
              title="ðŸ§¾ Tax Assistance RAG Chatbot",
              description="""
          Ask questions about the Indian Income Tax Act. 

          **Examples:**
          - What is Section 80C?
          - How to claim HRA exemption?
          - What are the tax slabs for individuals?
          - Explain capital gains tax
              """,
              examples=[
                  "What is Section 80C?",
                  "How to claim HRA exemption?",
                  "What are the tax slabs for individuals?",
                  "What deductions are available under Section 80D?",
                  "Explain the difference between old and new tax regime"
              ],
              retry_btn=None,
              undo_btn=None,
              clear_btn="Clear Chat",
          )

          if __name__ == "__main__":
              demo.launch()
          EOF
          
          # Create README.md for the Space
          cat > README.md << 'EOF'
          ---
          title: Tax Assistance RAG Chatbot
          emoji: ðŸ§¾
          colorFrom: blue
          colorTo: green
          sdk: gradio
          sdk_version: 5.11.0
          app_file: app.py
          pinned: false
          license: mit
          ---

          # Tax Assistance RAG Chatbot

          An AI-powered chatbot that answers questions about the Indian Income Tax Act using RAG (Retrieval-Augmented Generation).

          ## Features

          - ðŸ” Semantic search on Income Tax Act documents
          - ðŸ“š Uses FAISS vector database for efficient retrieval
          - ðŸ¤– Natural language responses with source attribution
          - ðŸ’¬ Interactive chat interface

          ## Example Questions

          - What is Section 80C?
          - How to claim HRA exemption?
          - What are the tax slabs for individuals?
          - What deductions are available under Section 80D?
          - Explain capital gains tax

          ## Technical Stack

          - **Vector Database**: FAISS
          - **Embeddings**: Sentence Transformers (all-MiniLM-L6-v2)
          - **Interface**: Gradio
          - **Backend**: Python

          ## Source

          This is part of the [Tax Assistance AI](https://github.com/Imkkrish/Tax-Assistance-AI) project.
          EOF
          
          # Update requirements.txt to include gradio if not already present
          if ! grep -qF 'gradio' requirements.txt 2>/dev/null; then
            echo "gradio>=5.11.0" >> requirements.txt
          fi
          
          # Add all files
          git add -A
          
          # Commit changes
          git commit -m "Deploy RAG Chatbot from GitHub Actions" || echo "No changes to commit"
          
          # Push to Hugging Face
          git push origin main --force
          
          echo "âœ… Deployment complete!"
          echo "ðŸ”— Space URL: ${SPACE_URL}"
